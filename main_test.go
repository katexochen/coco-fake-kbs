package main

import (
	"encoding/json"
	"testing"

	"github.com/go-jose/go-jose/v3"
	"github.com/stretchr/testify/assert"
)

var (
	attestStr = `{"tee-pubkey":{"kty":"RSA","alg":"RSA1_5","n":"q96WPNpLWANRhduW6eIm9lEa8YxXR47KZVtNswBkk1g60pxPmann_1KyN6x5YZb7jOGFlOfR_Si_NhOOmAosdzRUduARuRKAALaKDVPrRzqIlWVavkGEOjnwSdppp96ni3fw80JOL-gpan9xAZzeUhlo_u9XhZsuOx1g2A3Yo1LnsgszPcATk4jPwGyPhyA1WFxvmvPxakW531cgPrOJMPIVcR2lvgKLBjJNmjewyk-xcGXFUDYJPcOMCsiiuFwozHxqmfn5FSWQCstaRHaCYblFNZohLbPAKEnlOtV5qZhZnpC2UNwxKmKXMl60Pl0NMQW6nSbuEDLoz5EkJjeU3Q","e":"AQAB"},"tee-evidence":"{\"quote\":{\"signature\":[45,179,38,211,238,123,247,11,209,227,116,72,178,71,223,111,13,6,164,32,213,149,108,150,31,148,192,212,226,180,71,70,241,39,254,78,59,28,232,124,174,24,188,79,60,199,108,86,118,23,43,113,246,180,46,223,245,203,230,209,237,176,16,129,253,34,129,107,194,71,56,113,129,141,224,208,83,196,205,68,228,167,16,200,16,249,52,251,247,169,228,113,175,144,95,244,66,248,91,25,125,161,140,105,230,135,71,108,117,178,93,118,177,213,222,149,198,101,138,168,58,227,78,254,104,26,239,20,189,187,158,8,207,221,80,110,121,156,202,45,251,181,204,27,209,65,2,52,223,10,46,0,222,48,73,10,164,157,203,125,40,196,188,82,142,67,198,87,96,170,13,115,153,16,76,223,182,11,104,103,194,23,51,152,30,226,145,99,110,147,18,118,36,46,253,176,141,33,228,202,13,75,115,216,247,11,31,101,165,88,162,23,235,55,120,170,85,201,241,25,132,185,193,188,108,107,138,162,217,172,91,233,242,109,49,255,202,204,147,18,64,226,8,8,59,1,55,3,103,77,162,201,38,226,211,222],\"message\":[255,84,67,71,128,24,0,34,0,11,182,181,94,105,214,234,91,45,160,111,253,223,111,68,74,122,9,105,96,35,227,204,220,236,245,232,101,233,168,142,75,183,0,48,48,42,196,145,54,89,239,156,212,173,36,129,32,166,16,172,174,10,116,176,21,30,108,142,75,8,244,161,181,27,54,223,164,189,63,170,94,45,159,48,124,204,120,136,204,128,167,124,0,0,0,0,9,64,165,212,0,0,0,3,0,0,0,0,1,32,32,3,18,0,18,0,3,0,0,0,1,0,11,3,255,64,0,0,32,253,185,29,243,139,50,43,69,188,218,250,240,37,4,177,140,86,89,124,137,163,32,129,253,193,133,186,103,31,40,117,230]},\"report\":[72,67,76,65,1,0,0,0,27,7,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,4,0,0,0,31,0,3,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,3,0,0,0,0,0,8,206,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,77,223,153,104,33,250,0,76,148,29,80,164,178,226,120,108,161,240,150,154,129,39,101,39,78,223,128,1,205,107,59,222,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,161,243,147,4,19,36,123,179,140,252,23,21,121,234,60,18,213,254,73,1,240,199,146,246,63,215,93,152,241,239,130,124,35,80,6,68,224,230,146,230,190,145,127,144,80,211,211,140,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,86,33,88,130,168,37,39,154,133,179,0,176,183,66,147,29,17,59,247,227,45,222,46,80,255,222,126,199,67,202,73,30,205,215,243,54,220,40,166,224,178,187,87,175,122,68,163,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,200,33,128,152,5,114,61,219,68,222,186,39,213,8,69,86,36,60,240,28,143,249,154,65,203,40,126,243,18,189,49,172,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,3,0,0,0,0,0,8,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,91,178,110,96,84,8,232,188,175,179,80,249,105,215,93,137,227,126,141,48,49,112,76,81,85,179,2,244,113,238,103,214,163,209,47,28,255,76,244,135,147,79,57,172,62,205,142,252,215,3,204,135,25,198,239,45,100,125,253,158,190,21,224,175,3,0,0,0,0,0,8,115,4,52,1,0,4,52,1,0,3,0,0,0,0,0,8,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,180,212,31,155,80,120,241,206,89,188,187,251,144,48,188,98,240,224,154,117,133,51,144,240,240,95,209,88,51,88,36,159,148,128,105,122,181,149,210,2,175,90,184,105,46,5,83,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,85,0,220,4,82,171,219,159,40,55,194,16,6,165,142,110,227,33,248,29,145,60,150,68,74,169,195,3,226,80,202,203,151,88,101,97,177,212,215,181,65,33,75,50,124,6,37,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,91,2,0,0,1,0,0,0,2,0,0,0,1,0,0,0,71,2,0,0,123,34,107,101,121,115,34,58,91,123,34,107,105,100,34,58,34,72,67,76,65,107,80,117,98,34,44,34,107,101,121,95,111,112,115,34,58,91,34,101,110,99,114,121,112,116,34,93,44,34,107,116,121,34,58,34,82,83,65,34,44,34,101,34,58,34,65,81,65,66,34,44,34,110,34,58,34,114,97,85,57,75,65,65,66,72,79,72,95,115,89,49,107,72,117,113,77,75,49,108,70,88,65,54,105,70,104,48,54,101,71,71,66,95,69,78,45,115,57,52,119,48,114,116,120,119,89,113,111,53,56,67,67,48,115,104,67,53,113,110,84,67,53,57,77,72,107,108,51,48,73,87,73,107,88,84,98,49,51,104,115,115,52,75,79,109,107,109,109,101,68,117,119,115,84,50,119,112,85,70,83,67,71,54,86,102,75,50,97,56,82,107,72,55,100,54,69,85,122,100,98,72,85,55,119,111,79,100,80,54,88,122,110,76,53,65,106,97,81,45,85,50,106,95,121,88,108,55,103,86,111,53,116,48,50,117,54,95,74,55,45,54,82,113,97,86,71,95,73,56,76,83,116,103,54,80,105,115,102,107,89,78,77,49,69,66,112,75,110,79,85,55,104,119,81,72,51,76,111,76,79,98,98,50,102,71,86,71,76,53,77,115,66,70,82,54,109,85,98,106,108,120,116,100,84,111,53,70,111,55,75,111,71,48,51,89,80,72,75,68,78,55,104,84,54,66,48,117,74,71,104,79,116,66,99,86,56,56,102,71,104,70,76,115,57,121,97,85,76,102,102,51,102,120,55,82,89,102,48,115,89,66,49,52,65,73,79,77,55,112,101,49,100,82,95,65,114,68,56,103,115,53,77,107,55,55,108,79,48,75,115,98,54,45,105,121,99,104,87,121,57,66,85,83,65,69,75,100,52,70,86,120,120,110,105,49,115,89,119,34,125,93,44,34,118,109,45,99,111,110,102,105,103,117,114,97,116,105,111,110,34,58,123,34,99,111,110,115,111,108,101,45,101,110,97,98,108,101,100,34,58,116,114,117,101,44,34,99,117,114,114,101,110,116,45,116,105,109,101,34,58,49,54,56,53,54,49,49,49,51,54,44,34,115,101,99,117,114,101,45,98,111,111,116,34,58,116,114,117,101,44,34,116,112,109,45,101,110,97,98,108,101,100,34,58,116,114,117,101,44,34,118,109,85,110,105,113,117,101,73,100,34,58,34,48,67,56,57,49,68,57,67,45,55,57,54,65,45,52,66,66,67,45,56,65,69,66,45,66,70,55,67,51,69,66,57,50,51,52,65,34,125,125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"vcek\":\"-----BEGIN CERTIFICATE-----\\nMIIFTDCCAvugAwIBAgIBADBGBgkqhkiG9w0BAQowOaAPMA0GCWCGSAFlAwQCAgUA\\noRwwGgYJKoZIhvcNAQEIMA0GCWCGSAFlAwQCAgUAogMCATCjAwIBATB7MRQwEgYD\\nVQQLDAtFbmdpbmVlcmluZzELMAkGA1UEBhMCVVMxFDASBgNVBAcMC1NhbnRhIENs\\nYXJhMQswCQYDVQQIDAJDQTEfMB0GA1UECgwWQWR2YW5jZWQgTWljcm8gRGV2aWNl\\nczESMBAGA1UEAwwJU0VWLU1pbGFuMB4XDTIzMDUwMjE3MDEzNFoXDTMwMDUwMjE3\\nMDEzNFowejEUMBIGA1UECwwLRW5naW5lZXJpbmcxCzAJBgNVBAYTAlVTMRQwEgYD\\nVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExHzAdBgNVBAoMFkFkdmFuY2Vk\\nIE1pY3JvIERldmljZXMxETAPBgNVBAMMCFNFVi1WQ0VLMHYwEAYHKoZIzj0CAQYF\\nK4EEACIDYgAELLAJAFWtJTBU+JCobLFCtaRvsPxR6QJN1R8VrKzGgX42mumCliOn\\nOQdekjai1nlvqkDk8P8DyKf0WeUxiXnkb9iLmaLk/QAJP2VSDfF1RlxMbDYYOoHz\\nQpy2y0YwhfMNo4IBFjCCARIwEAYJKwYBBAGceAEBBAMCAQAwFwYJKwYBBAGceAEC\\nBAoWCE1pbGFuLUIwMBEGCisGAQQBnHgBAwEEAwIBAzARBgorBgEEAZx4AQMCBAMC\\nAQAwEQYKKwYBBAGceAEDBAQDAgEAMBEGCisGAQQBnHgBAwUEAwIBADARBgorBgEE\\nAZx4AQMGBAMCAQAwEQYKKwYBBAGceAEDBwQDAgEAMBEGCisGAQQBnHgBAwMEAwIB\\nCDARBgorBgEEAZx4AQMIBAMCAXMwTQYJKwYBBAGceAEEBEBbsm5gVAjovK+zUPlp\\n112J436NMDFwTFFVswL0ce5n1qPRLxz/TPSHk085rD7NjvzXA8yHGcbvLWR9/Z6+\\nFeCvMEYGCSqGSIb3DQEBCjA5oA8wDQYJYIZIAWUDBAICBQChHDAaBgkqhkiG9w0B\\nAQgwDQYJYIZIAWUDBAICBQCiAwIBMKMDAgEBA4ICAQBEa6iZLOIPoRfGHJ5SLq/W\\n45vYcv0X8lKddqjhW/YRJvNQvb+9SJhiZQqszF57Va9LkbGNsUAy7tulBgbagjKr\\nJqXBeadrZ2rH1sGhXKYiTOcbClFOTqgZvmIK9m7dVxJHoSK8QWhOeBjRqYMZ4LeQ\\nup0YZ5GMAJ1WCaJC/zvBzhS2c3fGHqUP+mK4x6doLhZrHhEcwYKMgAi6378XO9YA\\nun2cV+mU+Nqs7UMeJfd+MlFeNKFredWhdXsgIo2ESRgt60d+/YETZSqAquxPiKgC\\nZp+ic/hWY9rMtbEPAb1fus/AiwJrG/26KhB8JWCAn/htoAbg/sSGzBo4DXK7MDqS\\nL0Ybh28gz2q5JfsxGUQTCVuA1NsnF56rbR0k0c8+tq9MA7h6iJKHnoZvbIuyBJC4\\nSJn7pljJC4K3N5uwXUEzd5yjTShk66l5pPiMRtYQAo33bbZ4ElkSyyEqsSD2ELgZ\\norBWHcnPXFvE1J2yPjlVq8krlU9AtXsiomF+0DaAvMo83MoOEovsW5UcMt+Eb/+i\\nbfBmnk2PHRViKpfP6X+q9ZQY7RzAIZLwmrQgTgG8OJsUrdvPP6Km+XoQthVTrVRC\\nM7oKIprnA7pQ5nU5Iu1xUs/KUQ4Bn9vzncKYqCZ+kXBASfm161AzMUNngSeYlUGn\\nefcgySLAbpnQfPGaboYNTA==\\n-----END CERTIFICATE-----\\n\"}"}`
	keyStr    = `{"kty":"RSA","alg":"RSA1_5","n":"q96WPNpLWANRhduW6eIm9lEa8YxXR47KZVtNswBkk1g60pxPmann_1KyN6x5YZb7jOGFlOfR_Si_NhOOmAosdzRUduARuRKAALaKDVPrRzqIlWVavkGEOjnwSdppp96ni3fw80JOL-gpan9xAZzeUhlo_u9XhZsuOx1g2A3Yo1LnsgszPcATk4jPwGyPhyA1WFxvmvPxakW531cgPrOJMPIVcR2lvgKLBjJNmjewyk-xcGXFUDYJPcOMCsiiuFwozHxqmfn5FSWQCstaRHaCYblFNZohLbPAKEnlOtV5qZhZnpC2UNwxKmKXMl60Pl0NMQW6nSbuEDLoz5EkJjeU3Q","e":"AQAB"}`
)

func TestMarshalKey(t *testing.T) {
	key := marshalKey([]byte(attestStr))
	assert.True(t, key.Valid())
}

func marshalKey(body []byte) *jose.JSONWebKey {
	var req Attestation
	if err := json.Unmarshal(body, &req); err != nil {
		panic(err)
	}

	if !req.TEEPubKey.Valid() {
		panic("invalid tee pubkey")
	}

	return &req.TEEPubKey
}
